<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Supply Portal - Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        input[type="checkbox"] {
            accent-color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans pb-20">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyGVvjI36p-r9Hx_Qo3lxowckW1HkWP6uiFcwkvRn6KMr-5Osg1SRfUfhEFxlK95mIPPw/exec";
        let cart = [];
        let itemsData = [];
    </script>

    <div class="max-w-6xl mx-auto py-12 px-4">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-white mb-6 tracking-tight">Research Supply Portal</h1>
            <div class="bg-blue-900/30 border border-blue-500/50 p-6 rounded-2xl max-w-3xl mx-auto">
                <p class="text-blue-100 leading-relaxed italic text-lg">
                    "Welcome to my shop for all of your researching needs. All items sold here are strictly for research purposes and are not to be used on humans or animals."
                </p>
            </div>
        </header>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden mb-8 p-4 rounded-xl text-center font-medium shadow-2xl border"></div>

        <div class="flex flex-col lg:flex-row gap-10">
            
            <!-- Products List -->
            <div class="flex-1">
                <div id="loadingOverlay" class="flex flex-col justify-center items-center py-20">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-700 h-12 w-12 mb-4"></div>
                    <span class="text-gray-400 font-medium">Loading inventory...</span>
                </div>

                <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                    <!-- Injected by JS -->
                </div>
            </div>

            <!-- Cart Sidebar -->
            <div class="w-full lg:w-96">
                <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 sticky top-10 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center justify-between">
                        Your Bundle
                        <span id="cartCount" class="bg-blue-600 text-xs px-2 py-1 rounded-full">0</span>
                    </h2>
                    
                    <div id="cartList" class="space-y-4 max-h-[400px] overflow-y-auto mb-6 pr-2">
                        <p class="text-gray-500 text-center py-4 italic">No materials selected.</p>
                    </div>

                    <div id="cartTotal" class="border-t border-gray-700 pt-4 hidden">
                        <div class="flex justify-between items-center mb-6 px-1">
                            <span class="text-gray-400 font-medium">Total Amount:</span>
                            <span id="totalDisplay" class="text-2xl font-bold text-blue-400">0.00 €</span>
                        </div>
                        <button onclick="showCheckout()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg active:scale-95">
                            Proceed to Checkout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Checkout Modal -->
        <div id="checkoutModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-gray-800 w-full max-w-2xl rounded-3xl border border-gray-700 p-8 shadow-2xl max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h2 class="text-3xl font-bold text-white">Finalize Transmission</h2>
                    <button onclick="hideCheckout()" class="text-gray-400 hover:text-white text-2xl">✕</button>
                </div>
                <form id="orderForm" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Researcher Full Name *</label>
                            <input type="text" id="clientName" required placeholder="Dr. John Doe" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Contact Email *</label>
                            <input type="email" id="clientEmail" required placeholder="lab@institute.org" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Phone Number *</label>
                            <input type="tel" id="clientPhone" required placeholder="+1 234 567 890" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Telegram (Optional)</label>
                            <input type="text" id="telegram" placeholder="@researcher_id" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Signal (Optional)</label>
                            <input type="text" id="signal" placeholder="+1..." class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Purpose of Research</label>
                            <select id="researchPurpose" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option>Laboratory Analysis</option>
                                <option>Educational Use</option>
                                <option>Chemical Synthesis</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="shippingAddress" class="block text-sm font-medium text-gray-400 mb-1">Shipping Address *</label>
                        <textarea id="shippingAddress" required rows="3" placeholder="Full address for delivery" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition"></textarea>
                    </div>

                    <!-- Acknowledgements Section -->
                    <div class="space-y-4 pt-4 border-t border-gray-700">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="ack1" required class="mt-1 h-5 w-5 flex-shrink-0 cursor-pointer">
                            <label for="ack1" class="text-sm text-gray-300 cursor-pointer">
                                <span class="font-bold text-white block mb-1">Acknowledgement 1 *</span>
                                I acknowledge and agree that all items on this site are strictly for research purposes only, and not for human nor animal use.
                            </label>
                        </div>

                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="ack2" required class="mt-1 h-5 w-5 flex-shrink-0 cursor-pointer">
                            <label for="ack2" class="text-sm text-gray-300 cursor-pointer">
                                <span class="font-bold text-white block mb-1">Acknowledgement 2 *</span>
                                I understand that I must carefully review my full name and address before submitting this form. Delivery issues caused by incorrect or incomplete shipping details are of no responsibility to supplier. I also acknowledge that once the package is shipped, responsibility transfers to the carrier.
                            </label>
                        </div>

                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="ack3" required class="mt-1 h-5 w-5 flex-shrink-0 cursor-pointer">
                            <label for="ack3" class="text-sm text-gray-300 cursor-pointer">
                                <span class="font-bold text-white block mb-1">Acknowledgement 3 *</span>
                                I give consent on receiving a confirmation email, after submitting the form.
                            </label>
                        </div>
                    </div>

                    <div class="flex gap-4 pt-6">
                        <button type="submit" id="submitBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition shadow-lg active:scale-95">Confirm Transmission</button>
                        <button type="button" onclick="hideCheckout()" class="px-6 py-4 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600 transition">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        async function loadStocks() {
            try {
                const response = await fetch(`${API_URL}?action=getStocks`);
                const data = await response.json();
                itemsData = Array.isArray(data) ? data : [];
                renderProducts(itemsData);
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('productsGrid').classList.remove('hidden');
            } catch (error) {
                showStatus("Sync Error. Please check your connection.", "bg-red-900/50 text-red-200 border-red-500/50");
            }
        }

        function renderProducts(items) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            items.forEach(item => {
                const isOut = item.Stock <= 0;
                const card = document.createElement('div');
                card.className = `bg-gray-800 rounded-xl border ${isOut ? 'border-red-900/30 opacity-70' : 'border-gray-700 hover:border-blue-600/50'} transition-all p-4 flex flex-col justify-between shadow-md`;
                
                const safeName = item.Nom.replace(/'/g, "\\'");

                card.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="text-lg font-bold text-white leading-tight">${item.Nom}</h3>
                            <span class="text-blue-400 font-bold ml-2 whitespace-nowrap">${parseFloat(item.Price).toFixed(2)} €</span>
                        </div>
                        <div class="flex flex-wrap gap-x-4 gap-y-1">
                            <span class="text-[11px] font-mono ${isOut ? 'text-red-500' : 'text-green-500'} uppercase tracking-wider">Stock: ${item.Stock}</span>
                            ${item.ProchaineLivraison ? `<span class="text-[11px] text-gray-500 italic">Next: ${item.ProchaineLivraison}</span>` : ''}
                        </div>
                    </div>
                    <button 
                        onclick="addToCart('${item.ID}', '${safeName}', ${item.Stock}, ${item.Price})"
                        ${isOut ? 'disabled' : ''}
                        class="w-full py-2.5 rounded-lg text-sm font-bold transition ${isOut ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-500 active:scale-95'}"
                    >
                        ${isOut ? 'Unavailable' : 'Add to Bundle'}
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        function addToCart(id, name, maxStock, price) {
            const existing = cart.find(i => i.id === id);
            if (maxStock <= 0) {
                showStatus(`Item "${name}" is currently unavailable.`, "bg-red-900/50 text-red-200 border-red-500/50");
                return;
            }

            if (existing) {
                if (existing.quantity < maxStock) {
                    existing.quantity++;
                } else {
                    showStatus("Cannot exceed available stock.", "bg-blue-900/50 text-blue-200 border-blue-500/50");
                    return;
                }
            } else {
                cart.push({ id, name, quantity: 1, max: maxStock, price: parseFloat(price) });
            }
            updateCartUI();
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cartList');
            const totalSection = document.getElementById('cartTotal');
            const totalDisplay = document.getElementById('totalDisplay');
            const count = document.getElementById('cartCount');
            
            const totalItems = cart.reduce((acc, curr) => acc + curr.quantity, 0);
            const totalPrice = cart.reduce((acc, curr) => acc + (curr.quantity * curr.price), 0);
            
            count.textContent = totalItems;
            totalDisplay.textContent = `${totalPrice.toFixed(2)} €`;

            if (cart.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4 italic">No materials selected.</p>';
                totalSection.classList.add('hidden');
                return;
            }

            totalSection.classList.remove('hidden');
            list.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center bg-gray-900/50 p-3 rounded-xl border border-gray-700">
                    <div class="flex-1">
                        <p class="text-white font-semibold text-sm">${item.name}</p>
                        <p class="text-[10px] text-gray-400">Qty: ${item.quantity} × ${item.price.toFixed(2)} €</p>
                    </div>
                    <div class="text-right flex items-center gap-3">
                        <span class="text-xs font-bold text-blue-400">${(item.quantity * item.price).toFixed(2)} €</span>
                        <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-400 px-2 text-lg">✕</button>
                    </div>
                </div>
            `).join('');
        }

        function showCheckout() { document.getElementById('checkoutModal').classList.remove('hidden'); }
        function hideCheckout() { document.getElementById('checkoutModal').classList.add('hidden'); }

        function showStatus(msg, classes) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `mb-8 p-4 rounded-xl text-center font-medium shadow-2xl border ${classes}`;
            el.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => el.classList.add('hidden'), 8000);
        }

        document.getElementById('orderForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Processing...";

            const totalAmount = cart.reduce((acc, curr) => acc + (curr.quantity * curr.price), 0).toFixed(2);

            const formData = {
                action: 'addOrder',
                nom: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                telegram: document.getElementById('telegram').value,
                signal: document.getElementById('signal').value,
                address: document.getElementById('shippingAddress').value,
                purpose: document.getElementById('researchPurpose').value,
                totalAmount: totalAmount,
                cart: cart
            };

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(formData) });
                const result = await response.json();
                
                if (result.result === "success") {
                    showStatus("Transmission complete. Order logged in database.", "bg-green-900/50 text-green-200 border-green-500/50");
                    cart = [];
                    updateCartUI();
                    hideCheckout();
                    loadStocks();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showStatus("Transmission initialized. Please check your research log in a few seconds.", "bg-blue-900/50 text-blue-200 border-blue-500/50");
                cart = [];
                updateCartUI();
                hideCheckout();
                setTimeout(loadStocks, 3000);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        window.onload = loadStocks;
    </script>
</body>
</html>
